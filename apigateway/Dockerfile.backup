# Build stage with GraalVM
FROM ghcr.io/graalvm/native-image-community:17 AS build

# Install required build tools
RUN microdnf install -y findutils

WORKDIR /build

# Copy gradle wrapper and build files
COPY gradlew .
COPY gradle ./gradle
COPY build.gradle settings.gradle ./

# Download dependencies (cached layer)
RUN chmod +x gradlew && ./gradlew dependencies --no-daemon

# Copy source code
COPY src ./src

# Build native image
RUN ./gradlew nativeCompile --no-daemon

# Run stage - minimal base image
FROM ubuntu:22.04

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy the native executable
COPY --from=build /build/build/native/nativeCompile/apigateway-service ./app

# Make executable
RUN chmod +x ./app

# Expose the correct port from your properties
EXPOSE 8085

# âœ… Let Render set SPRING_PROFILES_ACTIVE
ENTRYPOINT ["./app"]